# Klui è¿œç¨‹å¼€å‘æ–¹æ¡ˆå¯¹æ¯”åˆ†æ

**Date**: 2026-01-11
**Purpose**: å¯¹æ¯”ä¸¤ç§è¿œç¨‹å¼€å‘å®ç°æ–¹æ¡ˆï¼Œæ¨èæœ€ä½³æ¶æ„

## ğŸ“‹ èƒŒæ™¯

**ç›®æ ‡**: åœ¨ç§»åŠ¨ç«¯å®ç°è¿œç¨‹è½¯ä»¶å¼€å‘åŠŸèƒ½

**éœ€æ±‚**:
- âœ… ç§»åŠ¨ç«¯ï¼ˆiOS/Androidï¼‰è¿œç¨‹æ§åˆ¶æœåŠ¡å™¨ç«¯å¼€å‘ç¯å¢ƒ
- âœ… å®æ—¶ä»£ç ç¼–è¾‘ã€æ‰§è¡Œã€æµ‹è¯•
- âœ… å·¥å…·è°ƒç”¨æ‰¹å‡†ï¼ˆæƒé™æ§åˆ¶ï¼‰
- âœ… æµå¼æ¶ˆæ¯æ˜¾ç¤º

**å‚è€ƒå®ç°**: Happy (slopus/happy)
- åœ¨æœåŠ¡å™¨è¿è¡Œ Claude Code
- Happy CLI åŒ…è£… Claude Code å¹¶é€šè¿‡ stream-json é€šä¿¡
- Happy å®¢æˆ·ç«¯ï¼ˆReact Nativeï¼‰æ¥æ”¶å¹¶æ˜¾ç¤ºæ¶ˆæ¯

## ğŸ” æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ 1: Happy æ¨¡å¼ï¼ˆLetta Code + Klui Clientï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Klui Mobile Client                  â”‚
â”‚         (Flutter - iOS/Android)             â”‚
â”‚  - èŠå¤© UI                                   â”‚
â”‚  - SSE/stream-json è§£æå™¨                   â”‚
â”‚  - å·¥å…·æ‰¹å‡† UI                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTP/SSE
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Letta Code (CLI Wrapper)            â”‚
â”‚  - åŒ…è£… Letta Code                          â”‚
â”‚  - --input-format stream-json               â”‚
â”‚  - è½¬å‘æ¶ˆæ¯åˆ° Letta åç«¯                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ Letta API
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Letta Backend Server                â”‚
â”‚  - Agent ç®¡ç†                               â”‚
â”‚  - è®°å¿†ç³»ç»Ÿ                                 â”‚
â”‚  - æœåŠ¡ç«¯å·¥å…·ï¼ˆrun_code, web_searchï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**:
- âœ… **å¯ä»¥å¿«é€Ÿå®ç°** - Letta Code å·²æœ‰å®Œæ•´çš„ stream-json æ ¼å¼
- âœ… **å·¥å…·æ‰§è¡Œå®Œæ•´** - Letta Code çš„å®¢æˆ·ç«¯å·¥å…·ï¼ˆRead, Write, Bashï¼‰å¯ç›´æ¥ä½¿ç”¨
- âœ… **å‚è€ƒå®ç°æˆç†Ÿ** - Happy å·²éªŒè¯æ­¤æ¶æ„å¯è¡Œ

**ç¼ºç‚¹**:
- âŒ **éœ€è¦è¿è¡Œä¸¤ä¸ªæœåŠ¡** - Letta Code + Letta Backend
- âŒ **åŠŸèƒ½å†—ä½™** - Letta Code çš„ Agent ç®¡ç†ã€UI åŠŸèƒ½ Klui å·²å®ç°
- âŒ **æ¶æ„å¤æ‚** - å¤šä¸€å±‚åŒ…è£…ï¼Œå¢åŠ ç»´æŠ¤æˆæœ¬
- âŒ **èµ„æºæµªè´¹** - Letta Code çš„ç»ˆç«¯ UI åŠŸèƒ½å®Œå…¨ç”¨ä¸ä¸Š

**Letta Code çš„ stream-json æ ¼å¼**:
```typescript
// ç³»ç»Ÿæ¶ˆæ¯
{
  type: 'system',
  subtype: 'init',
  session_id: string,
  model: string,
  cwd: string,
  tools: string[],
  slash_commands: string[]
}

// ç”¨æˆ·æ¶ˆæ¯ï¼ˆå·¥å…·è°ƒç”¨ç»“æœï¼‰
{
  type: 'user',
  message: {
    role: 'user',
    content: [
      { type: 'tool_result', tool_use_id: string, content: any }
    ]
  }
}

// åŠ©æ‰‹æ¶ˆæ¯ï¼ˆå·¥å…·è°ƒç”¨ï¼‰
{
  type: 'assistant',
  message: {
    role: 'assistant',
    content: [
      { type: 'tool_use', id: string, name: string, input: object }
    ]
  }
}

// æ§åˆ¶è¯·æ±‚ï¼ˆå·¥å…·æ‰¹å‡†ï¼‰
{
  type: 'control_request',
  request_id: string,
  request: {
    subtype: 'can_use_tool',
    tool_name: string,
    input: any
  }
}

// æ§åˆ¶å“åº”
{
  type: 'control_response',
  response: {
    subtype: 'success' | 'error',
    request_id: string,
    response?: PermissionResult
  }
}

// ç»“æœæ¶ˆæ¯
{
  type: 'result',
  subtype: 'success' | 'error_max_turns' | 'error_during_execution',
  session_id: string,
  num_turns: number,
  usage: {...},
  total_cost_usd: number
}
```

---

### æ–¹æ¡ˆ 2: ç›´æ¥ Letta åç«¯ï¼ˆæ¨èï¼‰â­

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Klui Mobile Client                  â”‚
â”‚         (Flutter - iOS/Android)             â”‚
â”‚  - èŠå¤© UI                                   â”‚
â”‚  - SSE è§£æå™¨ï¼ˆLetta åè®®ï¼‰                  â”‚
â”‚  - å·¥å…·æ‰¹å‡† UI                               â”‚
â”‚  - Agent ç®¡ç† UI                             â”‚
â”‚  - è®°å¿†ç®¡ç† UI                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTP/SSE (Letta API)
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Letta Backend Server                â”‚
â”‚  - Agent ç®¡ç†                               â”‚
â”‚  - è®°å¿†ç³»ç»Ÿ                                 â”‚
â”‚  - å·¥å…·ç³»ç»Ÿï¼š                               â”‚
â”‚    âœ… run_code (Python, JS, TS, R, Java)    â”‚
â”‚    âš ï¸ open_files (æ¥å£å·²å®šä¹‰ï¼Œæœªå®ç°)        â”‚
â”‚    âš ï¸ grep_files (æ¥å£å·²å®šä¹‰ï¼Œæœªå®ç°)        â”‚
â”‚    âœ… web_search                            â”‚
â”‚    âœ… fetch_webpage                         â”‚
â”‚    âœ… memory (core_memory, archival_memory)  â”‚
â”‚  - æ²™ç®±æ‰§è¡Œç¯å¢ƒ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**:
- âœ… **æ¶æ„ç®€æ´** - åªéœ€ä¸€ä¸ª Letta Backend
- âœ… **åŠŸèƒ½å®Œæ•´** - åç«¯æä¾› Agent ç®¡ç†ã€è®°å¿†ã€å·¥å…·æ‰§è¡Œ
- âœ… **æ˜“äºç»´æŠ¤** - å‡å°‘ä¸€å±‚åŒ…è£…ï¼Œé™ä½å¤æ‚åº¦
- âœ… **æ›´å¥½çš„æ§åˆ¶** - ç›´æ¥è®¿é—® Letta APIï¼ŒåŠŸèƒ½æ›´çµæ´»
- âœ… **ç¬¦åˆé•¿æœŸè§„åˆ’** - Letta åç«¯æ˜¯å®˜æ–¹æ–¹å‘

**ç¼ºç‚¹**:
- âš ï¸ **æ–‡ä»¶å·¥å…·æœªå®Œå…¨å®ç°** - `open_files`, `grep_files` æ ‡è®°ä¸º `NotImplementedError`
- âš ï¸ **éœ€è¦ç­‰å¾…æˆ–è‡ªè¡Œå®ç°** - å¯èƒ½éœ€è¦æ·»åŠ è‡ªå®šä¹‰å·¥å…·

**è§£å†³æ–¹æ¡ˆ**:
1. **ä½¿ç”¨ `run_code` å·¥å…·** - å¯ä»¥è¿è¡Œ Python/JS/TS ä»£ç æ“ä½œæ–‡ä»¶
2. **æ·»åŠ è‡ªå®šä¹‰å·¥å…·** - é€šè¿‡ Letta API æ³¨å†Œæ–‡ä»¶æ“ä½œå·¥å…·
3. **ç­‰å¾… Letta å›¢é˜Ÿå®ç°** - æ–‡ä»¶å·¥å…·æ¥å£å·²å®šä¹‰ï¼Œå¯èƒ½æ­£åœ¨å¼€å‘ä¸­

---

## ğŸ¯ æ–¹æ¡ˆæ¨è

### **æ¨èæ–¹æ¡ˆ 2: ç›´æ¥ Letta åç«¯** â­

**ç†ç”±**:

1. **æ¶æ„æ›´ç®€æ´**
   - æ–¹æ¡ˆ 1 éœ€è¦ 3 å±‚ï¼šKlui â†’ Letta Code â†’ Letta Backend
   - æ–¹æ¡ˆ 2 åªéœ€ 2 å±‚ï¼šKlui â†’ Letta Backend

2. **Letta åç«¯åŠŸèƒ½å®Œæ•´**
   - Agent ç®¡ç†ï¼šâœ… å®Œå…¨æ”¯æŒ
   - è®°å¿†ç³»ç»Ÿï¼šâœ… å®Œå…¨æ”¯æŒ
   - å·¥å…·æ‰§è¡Œï¼šâœ… æœ‰æ²™ç®±ç¯å¢ƒï¼Œ`run_code` å¯ç”¨
   - æƒé™æ§åˆ¶ï¼šâœ… API æ”¯æŒ

3. **æ–‡ä»¶å·¥å…·çš„è§£å†³æ–¹æ¡ˆ**
   ```python
   # æ–¹æ¡ˆ A: ä½¿ç”¨ run_code æ‰§è¡Œæ–‡ä»¶æ“ä½œ
   run_code(code='''
   import os
   os.system("grep -r "TODO" ./src")
   ''', language="python")

   # æ–¹æ¡ˆ B: æ·»åŠ è‡ªå®šä¹‰å·¥å…·ï¼ˆé€šè¿‡ Letta APIï¼‰
   POST /api/v1/tools
   {
     "name": "read_file",
     "description": "Read a file from the server workspace",
     "source_code": "async def read_file(path: str) -> str: ..."
   }
   ```

4. **Letta åç«¯çš„å‘å±•æ–¹å‘**
   - Letta Code çš„å®¢æˆ·ç«¯å·¥å…·æ˜¯**ä¸´æ—¶æ–¹æ¡ˆ**
   - Letta å›¢é˜Ÿæ­£åœ¨å°†å·¥å…·è¿ç§»åˆ°åç«¯
   - æ–‡ä»¶å·¥å…·æ¥å£å·²å®šä¹‰ï¼Œè¯´æ˜æ­£åœ¨å®ç°ä¸­

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½ | æ–¹æ¡ˆ 1 (Happy æ¨¡å¼) | æ–¹æ¡ˆ 2 (Letta åç«¯) |
|------|-------------------|-------------------|
| **Agent ç®¡ç†** | âœ… Letta Code ç®¡ç† | âœ… Klui ç›´æ¥ç®¡ç† |
| **è®°å¿†ç³»ç»Ÿ** | âœ… Letta Code ç®¡ç† | âœ… Klui ç›´æ¥ç®¡ç† |
| **æ–‡ä»¶è¯»å–** | âœ… Letta Code å®¢æˆ·ç«¯å·¥å…· | âš ï¸ éœ€å®ç°ï¼ˆå¯ç”¨ run_codeï¼‰ |
| **æ–‡ä»¶å†™å…¥** | âœ… Letta Code å®¢æˆ·ç«¯å·¥å…· | âš ï¸ éœ€å®ç°ï¼ˆå¯ç”¨ run_codeï¼‰ |
| **å‘½ä»¤æ‰§è¡Œ** | âœ… Letta Code å®¢æˆ·ç«¯å·¥å…· | âš ï¸ éœ€å®ç°ï¼ˆå¯ç”¨ run_codeï¼‰ |
| **ä»£ç æ‰§è¡Œ** | âŒ æ—  | âœ… run_code å·¥å…· |
| **ç½‘é¡µæœç´¢** | âŒ æ—  | âœ… web_search å·¥å…· |
| **å·¥å…·æ‰¹å‡†** | âœ… stream-json åè®® | âœ… Letta API |
| **æµå¼å“åº”** | âœ… stream-json æ ¼å¼ | âœ… SSE åè®® |
| **æ¶æ„å¤æ‚åº¦** | âŒ 3 å±‚ | âœ… 2 å±‚ |
| **æœåŠ¡æ•°é‡** | âŒ 2 ä¸ª | âœ… 1 ä¸ª |

---

## ğŸš€ å®æ–½å»ºè®®

### **é˜¶æ®µ 1: ä½¿ç”¨ Letta åç«¯æ ¸å¿ƒåŠŸèƒ½**

1. **å®ç°åŸºæœ¬èŠå¤©åŠŸèƒ½**
   ```dart
   // ä½¿ç”¨ Letta API å‘é€æ¶ˆæ¯
   POST /v1/agents/{agent_id}/messages
   {
     "messages": [
       { "role": "user", "content": "Hello" }
     ]
   }
   ```

2. **å®ç° SSE æµå¼å“åº”**
   ```dart
   // ç›‘å¬ SSE æµ
   final stream = client.agents.messages.stream(agentId, {...});
   await for (final chunk in stream) {
     // å¤„ç†æ¶ˆæ¯ï¼šassistant, tool_call, tool_return
   }
   ```

3. **å®ç°å·¥å…·æ‰¹å‡†æµç¨‹**
   ```dart
   // å½“æ”¶åˆ° tool_call_message æ—¶
   // 1. æ˜¾ç¤ºå·¥å…·è°ƒç”¨è¯¦æƒ…
   // 2. ç”¨æˆ·æ‰¹å‡†/æ‹’ç»
   // 3. å‘é€æ‰¹å‡†ç»“æœ
   POST /v1/runs/{run_id}/submit_tool_outputs
   {
     "tool_outputs": [
       { "tool_call_id": "...", "output": "..." }
     ]
   }
   ```

### **é˜¶æ®µ 2: æ‰©å±•æ–‡ä»¶æ“ä½œèƒ½åŠ›**

**é€‰é¡¹ A: ç­‰å¾… Letta åç«¯å®ç°**
- è”ç³» Letta å›¢é˜Ÿï¼Œè¯¢é—®æ–‡ä»¶å·¥å…·çš„å®ç°æ—¶é—´è¡¨
- å¯èƒ½å¾ˆå¿«å°±ä¼šå®ç°ï¼ˆæ¥å£å·²å®šä¹‰ï¼‰

**é€‰é¡¹ B: æ·»åŠ è‡ªå®šä¹‰å·¥å…·**
```dart
// é€šè¿‡ Letta API æ·»åŠ æ–‡ä»¶æ“ä½œå·¥å…·
POST /v1/tools
{
  "name": "server_read_file",
  "description": "Read a file from server workspace",
  "source_code": '''
async def server_read_file(path: str) -> str:
    """Read file from server workspace directory"""
    with open(path, 'r') as f:
        return f.read()
  ''',
  "tool_type": "python"
}
```

**é€‰é¡¹ C: ä½¿ç”¨ run_code å·¥å…·**
```dart
// è®© Agent ä½¿ç”¨ run_code å·¥å…·æ‰§è¡Œæ–‡ä»¶æ“ä½œ
final response = await agent.sendMessage('''
è¯·ä½¿ç”¨ run_code å·¥å…·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
1. è¯»å– src/main.ts æ–‡ä»¶
2. æœç´¢ "TODO" å…³é”®å­—
3. è¿”å›ç»“æœ
''');
```

### **é˜¶æ®µ 3: å®Œæ•´çš„è¿œç¨‹å¼€å‘ä½“éªŒ**

1. **æ–‡ä»¶æµè§ˆå™¨ UI**
   - æ˜¾ç¤ºæœåŠ¡å™¨å·¥ä½œç›®å½•çš„æ–‡ä»¶åˆ—è¡¨
   - æ”¯æŒæ–‡ä»¶é¢„è§ˆ

2. **ç»ˆç«¯è¾“å‡º**
   - æ˜¾ç¤º `run_code` çš„æ‰§è¡Œç»“æœ
   - æ”¯æŒå®æ—¶æ—¥å¿—

3. **ä»£ç ç¼–è¾‘å™¨**
   - ç§»åŠ¨ç«¯å‹å¥½çš„ä»£ç ç¼–è¾‘å™¨
   - è¯­æ³•é«˜äº®ã€è‡ªåŠ¨è¡¥å…¨

---

## ğŸ’¡ å…³é”®æŠ€æœ¯å†³ç­–

### **SSE vs stream-json**

**æ–¹æ¡ˆ 1 éœ€è¦å®ç° stream-json è§£æå™¨**:
```dart
// stream-json æ ¼å¼ï¼ˆLetta Code ä¸“ç”¨ï¼‰
{
  "uuid": "...",
  "type": "message",
  "session_id": "...",
  "message": {
    "role": "assistant",
    "content": [...]
  }
}
```

**æ–¹æ¡ˆ 2 ä½¿ç”¨æ ‡å‡† SSE åè®®**:
```dart
// Letta åç«¯ SSE æ ¼å¼ï¼ˆæ ‡å‡†ï¼‰
data: {"type":"assistant_message", "content":"..."}

data: {"type":"tool_call", "tool_name":"...", "input":{...}}

data: [DONE]
```

**æ¨è**: æ–¹æ¡ˆ 2 çš„ SSE æ›´ç®€å•ã€æ›´æ ‡å‡†ã€‚

---

## ğŸ“ æ€»ç»“

### **æœ€ç»ˆæ¨è: æ–¹æ¡ˆ 2ï¼ˆç›´æ¥ Letta åç«¯ï¼‰**

**åŸå› **:
1. âœ… æ¶æ„æ›´ç®€æ´ã€æ›´æ˜“ç»´æŠ¤
2. âœ… Letta åç«¯åŠŸèƒ½å®Œæ•´ï¼ˆAgentã€è®°å¿†ã€å·¥å…·ï¼‰
3. âœ… ç¬¦åˆ Letta å®˜æ–¹å‘å±•æ–¹å‘
4. âš ï¸ æ–‡ä»¶å·¥å…·å¯é€šè¿‡ `run_code` æˆ–è‡ªå®šä¹‰å·¥å…·è§£å†³

**å®æ–½è·¯å¾„**:
1. **Phase 1**: å®ç°åŸºæœ¬èŠå¤© + SSE + å·¥å…·æ‰¹å‡†
2. **Phase 2**: æ·»åŠ  `run_code` å·¥å…·æ”¯æŒï¼ˆä»£ç æ‰§è¡Œï¼‰
3. **Phase 3**: æ‰©å±•æ–‡ä»¶æ“ä½œèƒ½åŠ›ï¼ˆè‡ªå®šä¹‰å·¥å…·æˆ–ç­‰å¾…å®˜æ–¹å®ç°ï¼‰

**ä¸é€‰æ‹©æ–¹æ¡ˆ 1 çš„åŸå› **:
- âŒ å¤šä¸€å±‚åŒ…è£…ï¼Œå¢åŠ å¤æ‚åº¦
- âŒ Letta Code çš„åŠŸèƒ½ Klui å·²å®ç°ï¼ˆå†—ä½™ï¼‰
- âŒ éœ€è¦ç»´æŠ¤é¢å¤–çš„ stream-json åè®®è§£æå™¨

---

## ğŸ”— ç›¸å…³èµ„æº

- **Letta åç«¯**: https://github.com/letta-ai/letta
- **Letta æ–‡ä»¶å·¥å…·**: `letta/functions/function_sets/files.py`
- **Letta ä»£ç æ‰§è¡Œ**: `letta/functions/function_sets/builtin.py`
- **Happy CLI**: https://github.com/slopus/happy-cli
- **Happy Server**: https://github.com/slopus/happy-server
- **Letta Code stream-json**: `letta-code/src/types/protocol.ts`
